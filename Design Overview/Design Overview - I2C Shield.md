**I2C Shield Revision A4 - Design Overview**  
=======================================
Jericho Laboratory Inc.  
Documentation licence: CC-BY-SA.  

**Warning**: The following material is for educational purposes only. Always refer to the schematic and PCB layout files associated with your product version.

**Table of Contents**

1. [Generalities About the I2C Shield](#generalities-about-the-i2c-shield)
2. [I2C Communication](#i2c-communication)
3. [I2C Extender (LTC4311)](#i2c-extender-ltc4311)
4. [I2C Multiplexer (TCA9548)](#i2c-multiplexer-tca9548)
5. [GPIO I2C Expander (PCF8574)](#gpio-i2c-expander-pcf8574)  
  a. [MOSFET Transistors (AO3401/AO3406)](#mosfet-transistors-ao3401ao3406)
7. [Cables](#cables)
8. [Other](#other)


## GENERALITIES ABOUT THE I2C SHIELD

- The I2C shield allows the RDL to communicate with eight sensors based on I2C communication.
- Multiplexing is a technical term to describe the ability to communicate with multiple devices one-at-a-time using a single channel. This is a common technique to reduce the hardware requirements in electronics project. It implies that the Arduino will connect to each I2C sensor one after the other.
- Up to three I2C shields can be connected by stacking them below the RDL. They all form a single I2C bus.


## I2C COMMUNICATION

- I2C protocol was developed for inter processor communication (1m meter max). However, there are ways to extend this distance. In the present design, the maximum is intended to be about 30m. Depending on the exact setup and environmental conditions, it could be less.
- An I2C protocol is a two-wire protocol: one for the clock (SCL, for signal clock) and one for the data (SDA for signal data).
- The I2C protocol is proprietary. In reality, a similar generic protocol called "two-wire protocole" is used. In this document, the two terms are used interchangeably. 
- There can only be a single device with the same I2C address on a given bus. Otherwise, two or more devices would ‘respond’ at the same time when being ‘talked’ to.
- Some I2C chips are more convenient as they can use more than one address. This is usually done by pulling high/low one or more pins on the chip. Some breakout boards can have solder jumpers cut/soldered to make this address permanent.
- An I2C address has the format "0x__". Examples include: 0x44, 0x42, etc.
- Many projects dedicated to I2C multiplexing only affect the SDA and SCL lines. This allows you to communicate with multiple I2C devices, even if they all have the same I2C address. However, these projects do not multiplex the supply lines, which can create problems of their own when using long wires (noisy supply lines). It was therefore necessary to create a different multiplexing solution, one that would multiplex all lines.
- There are 8 multiplexed channels, each of which has an RJ45 connector. The channels are numbered from 1 to 8. The silkscreen indicates the channel 1 and 8. Channels 1 to 7 are unshielded; channel 8 is shielded (metallic surface) and has two LEDS, one of which lights up when active. This was a test for revision A4 to improve debugging.



## I2C EXTENDER (LTC4311)

- Long distances bring a few problems: excessive capacitance, excessive inductance and excessive noise.
- While not located on the shield - it is located on the RDL PCB - the I2C extender has a strong relationship with the I2C shield, as it allows long distance communication of all I2C sensors, multiplexed and non-multiplexed.
- The choice of having the I2C chip on the RDL instead of the shield is based on two reasons: 
  1) It allows the RDL to communicate with a single I2C sensor at a long distance without the use of an I2C shield. 
  2) Having the extender chip on the RDL also enables the use of multiple I2C shield. Indeed, the use of three I2C shields would imply having three I2C extender on the I2C bus. The negative interactions would cause a bus dysfunction.
- The I2C extender chip used is the LTC4311. It works by providing extra potential to the rising edges of the I2C signal.
- I2C extender works in combination with the pull-up resistors. There are pull-up resistors near the master (RDL/Nano) and there generally are near the slave devices, too.
- The I2C extender must be close to the Arduino Nano, so that it can operate properly. This is because the clock signal (SCL), which drives the protocol, is generated by the master (Nano).
- The I2C shield contains two main RJ45 connectors (unmultiplexed). They are identical and interchangeable as they are both connected to the same I2C bus. A first connector is used to connect the shield to the RDL. The second connector can be used to connect to either 1) a second shield; or 2) a supplementary I2C device (no multiplexing).

## I2C MULTIPLEXER (TCA9548)

- TCA9548APWR is a chip multiplexer for I2C communication. It has 3 address pins (A0, A1, A2), which can be pulled high or low, allowing 8 different I2C addresses.
- The TCA9548 (1 chip) and the PCF8574 (2 chips) each require 3 solder jumpers for permanent I2C addresses. This avoids inner-board conflict between the two PCF chips and inter-board conflicts between TCA/PCF chips on the three shields instances, if applicable. Using more than one shield therefore requires manual soldering required.
- Default addresses (factory)
  - TCA9548: 0x70
  - PCF8574 #1 (High-Side): 0x22
  - PCF8574 #2 (Low-Side): 0x23
- To avoid picking up noise on the power supply lines via 8 cables of up to 30m, the power lines are also multiplexed. They are multiplexed on both the high-side (VCC) and the low-side (GND).

## GPIO I2C EXPANDER (PCF8574)

- PCF8574T is a GPIO (General Purpose Input Output) I2C expander. It can multiplex a signal or power line using I2C communication. In the I2C shield, this chip is used to multiplex the two power lines (VCC and GND). It does so indirectly by activating/deactivating MOSFET transistors.
- The use of transistors is unavoidable because the maximum current output from a Nano VCC pin is 500mA when powered by a USB cable. This is way above the limit of the PCF8674 (80mA), the CD74HC4051MM96EP (25 mA) or a Nano pin directly (20mA). By using transistors, the shield allows any sensor that would have functioned properly if directly connected to the Nano supply.
- The PCF8574T is preferable to alternatives like the CD74HC because it does not require additional cables to select the channels, which would be difficult with a shield only connected to the RDL via a CAT cable.
- The PCF8574 is a bit unusual and is described as “an open-drain output with a 100K resistor pull-up built in”. This mean that the output is inverted: when the channel is inactive, the output is high, and when the channel is active, the output is low. However, the Adafruit library manages this, so that the behavior is more intuitive for the user.

  ## MOSFET TRANSISTORS (AO3401/AO3406)

  - Choice of components:
    - P-channel MOSFET (high-side): AO3401 (max -4.0A)
    - N-channel MOSFET (low-side): AO3406 (max 3.6A)
  - High-side and low-side configuration are sometimes called Source and Sink configuration, respectively.  
  - High-side transistors, whether in MOSFET (P-channel) or Darlington (PNP) versions, require a low signal (i.e. ground) to be activated. This means that the same signal cannot be used to activate the high-side and low side-multiplexer chips. One solution is to use a separate GPIO multiplexer for each, like the PCF8574T. This implies that a 3-shield stacked system would have 6 PCF8574T with 6 different I2C addresses (out of a possibility of 8). For a given channel, one PCF will send a high signal to the AO3406’S and the other PCF will send a low signal to the AO3401’S. The downside of this strategy is that it adds one more device on the I2C bus.
  - Note that the PCF8574 has ‘latched outputs’ so all pins can be set simultaneously to HIGH, if needed be, if the PCF8574 max current threshold is respected.  
  - On the MOSFET diagram, the body diode has to be oriented so that there is no flow in normal operation. The other internal arrow indicates that the gate is activated by comparison with the voltage at the source (V_GS). With P-channel, we must be at least 2V beneath the source voltage. With N-Channel, we must be at least 2V above the source voltage.  
  - There is no need to use a gate resistor to limit in-rush current at the gate with a MOSFET. This is because MOSFETs are voltage-driven, while BJT’s are current driven.  

## CABLES

- The I2C shield connects to the RDL via RJ45 connectors and an Ethernet (CAT) cable. If using more than one I2C shield, a jumper CAT cable is also required in between each shield. 
- Multiple versions of the CAT cable exist: CAT5, CAT5e, CAT6, CAT7 can all be used. Earlier standards are usually cheaper, but they are progressively phased out of high-volume production, which could affect their price.
- Both shielded and unshielded cables can be used. The product design tries to minimize the impact of EMI but shielded cable can be required for best performance in the most noisy environments.

## OTHER

- A LED is present on the board to indicate that the board is supplied in power.
- Another LED was temporarily added to the VCC of channel 1 to indicate that this MOSFET works correctly. This is useful for troubleshooting.
- There are holes around the board to help attach the wires and reduce mechanical stress on the wires.

<figure>
<p align="center">
<img src="../Design Overview/images/I12 shield RevA2.png" style="width:40%">
  </p>
</figure>
<p align="center">
Diagram for the MOSFETs pairs controlling the sensors power supply
</p>